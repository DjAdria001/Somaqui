<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pedir Ayuda ‚Äì SomAqui.cat</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="icon" href="Imagenes/LogoSF.png" type="image/png" />
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="css/Styleglobal.css" />
  <link rel="stylesheet" href="css/FormularioAyuda.css" />
</head>

<body>
  <header class="site-header">
    <div class="header-top">
      <!-- Bot√≥n login a la derecha -->
      <button id="btn-login" aria-label="Iniciar sesi√≥n">
        <svg xmlns="http://www.w3.org/2000/svg" fill="white" width="28" height="28" viewBox="0 0 24 24">
          <path
            d="M12 2C9.243 2 7 4.243 7 7s2.243 5 5 5 5-2.243 5-5-2.243-5-5-5zm0 14c-4.418 0-8 3.134-8 7h2c0-2.761 2.686-5 6-5s6 2.239 6 5h2c0-3.866-3.582-7-8-7z" />
        </svg>
      </button>
    </div>

    <a href="Home.html" class="logo" aria-label="Ir a la p√°gina principal de SomAqui.cat">
      <img src="Imagenes/LogoSF.png" alt="Logo SomAqui.cat" />
      SomAqui.cat
    </a>

    <button class="menu-toggle" aria-controls="main-menu" aria-expanded="false" aria-label="Abrir men√∫ de navegaci√≥n">
      <i class="fa fa-bars"></i>
    </button>

    <nav class="main-nav" role="navigation" aria-label="Men√∫ principal">
      <ul class="nav-list" id="main-menu">
        <li class="nav-item"><a href="Home.html" class="nav-link" aria-current="page">Home</a></li>
        <li class="nav-item"><a href="FormularioAyuda.html" class="nav-link">Necesito Ayuda</a></li>
        <li class="nav-item"><a href="Ayudar.html" class="nav-link">Quiero ser voluntario</a></li>
        <li class="nav-item dropdown" tabindex="0">
          <a href="QuienesSomos.html" class="nav-link" aria-haspopup="true" aria-expanded="false">
            ¬øQui√©nes Somos? <i class="fa fa-caret-down" aria-hidden="true"></i>
          </a>
          <ul class="dropdown-menu" aria-label="Submen√∫ Quienes Somos">
            <li><a href="Equipo.html" class="dropdown-link">Equipo</a></li>
            <li><a href="MisionVision.html" class="dropdown-link">Misi√≥n y Visi√≥n</a></li>
            <li><a href="PreguntasFrecuentes.html" class="dropdown-link">Preguntas frecuentes</a></li>
            <li><a href="Contacto.html" class="dropdown-link">Contacto</a></li>
          </ul>
        </li>
      </ul>
    </nav>
  </header>

  <main>
    <h2>üö® Solicita ayuda en tu zona</h2>
    <p>Selecciona una o m√°s situaciones que est√°s viviendo. La ubicaci√≥n no se mostrar√° p√∫blicamente.</p>

    <form id="form-ayuda" novalidate>
      <div class="ubicacion-mapa">
        <div class="mapa-contenedor">
          <input type="hidden" id="ubicacion" name="ubicacion" required />

          <button type="button" id="ubicacion-texto" class="ubicacion-display" aria-label="Detectar ubicaci√≥n autom√°ticamente">
            üìç Detectar mi ubicaci√≥n autom√°ticamente
          </button>

          <div class="descripcion-ubicacion">
            Haz clic arriba para detectar autom√°ticamente o selecciona manualmente en el mapa.
            Es necesaria para conectar con servicios cercanos.
          </div>

          <div id="map" style="height: 250px; margin-bottom: 1rem;"></div>

          <label for="desc_ubic">üó∫Ô∏è Detalles de ubicaci√≥n (opcional)</label>
          <input type="text" name="desc_ubic" id="desc_ubic" placeholder="Ej: En la rotonda, cerca del ambulatorio..." />
        </div>

        <div class="form-derecha">
          <label for="nombre">üë§ Nombre o alias *</label>
          <input type="text" name="nombre" id="nombre" required placeholder="Tu nombre o alias" />

          <label for="correo">üìß Correo electr√≥nico *</label>
          <input type="email" name="correo" id="correo" required placeholder="ejemplo@correo.com" />

          <label for="telefono">üì± Tel√©fono m√≥vil (opcional)</label>
          <input type="tel" name="telefono" id="telefono" placeholder="Ej: 612 345 678" />

          <label for="personales">üë• ¬øEs solo para ti o para otras personas tambi√©n?</label>
          <input type="text" name="personales" id="personales" placeholder="Ej: Solo para m√≠ o para mi familia" />

          <label for="tiempo">‚è∞ ¬øDesde cu√°ndo ocurre la situaci√≥n? *</label>
          <input type="text" name="tiempo" id="tiempo" required placeholder="Ej: 30 minutos" />
        </div>
      </div>

      <div class="seccion-emergencia">
        <h2 class="titulo-emergencia">Emergencia</h2>
        <label class="etiquetas-titulo">üÜò Selecciona una o m√°s etiquetas *</label>
      </div>

      <div class="categorias-grid">
        <!-- Aqu√≠ van todas las categor√≠as y etiquetas igual que antes -->
        <!-- ... copia las etiquetas aqu√≠ ... -->
        <!-- Para abreviar no las repito, en tu archivo copia las etiquetas de tu ejemplo -->
      </div>

      <div class="descripcion-seccion">
        <label for="descripcion">üìù Describe tu situaci√≥n (opcional)</label>
        <textarea name="descripcion" id="descripcion"
          placeholder="Ej: Estoy sin electricidad desde hace 3 horas y necesito ayuda urgente..."></textarea>
      </div>

      <div class="checkbox-term">
        <input type="checkbox" id="terminos" required />
        <label for="terminos">Acepto los <a href="#" id="abrir-terminos">t√©rminos y condiciones</a> *</label>
      </div>

      <button type="submit">Enviar solicitud</button>
      <div class="privacidad">Tus datos se usan √∫nicamente para activar ayuda cercana.</div>
      <div class="privacidad">Por favor, usa este formulario de manera seria y responsable.</div>
    </form>
  </main>

  <div id="modal-terminos"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div
      style="background:white; padding:2rem; border-radius:10px; max-width:700px; width:90%; height:90%; overflow:auto; position:relative;">
      <button onclick="cerrarModal()"
        style="position:absolute; top:10px; right:15px; background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
      <h2>T√©rminos y Condiciones de Uso ‚Äì SomAqui.cat</h2>
      <p><strong>√öltima actualizaci√≥n: julio de 2025</strong></p>
      <p><strong>1. Objeto del servicio</strong><br>SomAqui.cat permite a los usuarios registrarse para compartir su
        ubicaci√≥n aproximada y necesidades espec√≠ficas mediante etiquetas, conectarse con personas u organizaciones
        dispuestas a colaborar y participar en iniciativas comunitarias.</p>
      <p><strong>2. Registro de usuarios</strong><br>Se recopilan datos como nombre/alias, correo electr√≥nico y
        ubicaci√≥n aproximada. El usuario debe proporcionar informaci√≥n veraz.</p>
      <p><strong>3. Protecci√≥n de datos personales</strong><br>Se aplica el RGPD. Los datos se tratan confidencialmente
        y no se comparten sin consentimiento.</p>
      <p><strong>4. Uso adecuado</strong><br>Est√° prohibido el uso con fines fraudulentos, pol√≠ticos, comerciales o
        discriminatorios.</p>
      <p><strong>5. Limitaci√≥n de responsabilidad</strong><br>SomAqui.cat act√∫a como intermediario. No garantiza la
        veracidad ni disponibilidad de ayuda.</p>
      <p><strong>6. Modificaciones</strong><br>Nos reservamos el derecho a modificar los t√©rminos en cualquier momento.
      </p>
      <p><strong>7. Aceptaci√≥n</strong><br>Usar la plataforma implica aceptar estos t√©rminos.</p>
      <hr />
      <h3>Pol√≠tica de Privacidad</h3>
      <p><strong>Responsable:</strong> SomAqui.cat</p>
      <p><strong>Finalidad:</strong> Plataforma de ayuda comunitaria. Datos tratados para conectar necesidades con ayuda
        local.</p>
      <p><strong>Base legal:</strong> Consentimiento del usuario.</p>
      <p><strong>Acceso a datos:</strong> Solo el equipo de SomAqui.cat. No hay cesiones sin consentimiento.</p>
      <p><strong>Conservaci√≥n:</strong> Mientras seas usuario. Puedes solicitar la eliminaci√≥n.</p>
      <p><strong>Seguridad:</strong> Se aplican medidas t√©cnicas y organizativas de protecci√≥n.</p>
      <p><strong>Derechos:</strong> Acceso, rectificaci√≥n, eliminaci√≥n, oposici√≥n. Contacta con nosotros para
        ejercerlos.</p>
    </div>
  </div>

  <footer id="contacto">
    <p>
      <a href="#" onclick="abrirModal()">T√©rminos y condiciones</a> |
      <a href="Contacto.html">Contacto</a> |
      <a href="Home.html">Inicio</a>
    </p>
    <small>¬© 2025 SomAqui.cat ‚Äì Todos los derechos reservados.</small>
  </footer>

  <script>
    // Variables globales
    let map, marker;

    // Inicializar mapa Leaflet
    function initMap() {
      map = L.map('map').setView([41.3851, 2.1734], 13); // Barcelona por defecto

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19,
      }).addTo(map);

      // Marcador arrastrable para seleccionar ubicaci√≥n manual
      marker = L.marker([41.3851, 2.1734], { draggable: true }).addTo(map);

      marker.on('dragend', () => {
        const pos = marker.getLatLng();
        document.getElementById('ubicacion').value = `${pos.lat.toFixed(6)},${pos.lng.toFixed(6)}`;
      });

      // Al clicar en mapa cambia marcador
      map.on('click', e => {
        marker.setLatLng(e.latlng);
        document.getElementById('ubicacion').value = `${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}`;
      });
    }

    // Detectar ubicaci√≥n autom√°tica
    document.getElementById('ubicacion-texto').addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert('Geolocalizaci√≥n no est√° soportada por tu navegador.');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          marker.setLatLng([lat, lng]);
          map.setView([lat, lng], 15);
          document.getElementById('ubicacion').value = `${lat.toFixed(6)},${lng.toFixed(6)}`;
          document.getElementById('ubicacion-texto').textContent = `üìç Ubicaci√≥n detectada: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
        },
        () => alert('No se pudo obtener la ubicaci√≥n. Por favor, permite acceso o selecciona manualmente.'),
        { enableHighAccuracy: true, timeout: 10000 }
      );
    });

    // Toggle campo texto "Otros"
    const otrosCheck = document.getElementById('otros-check');
    const otrosTexto = document.getElementById('otros-texto-container');

    otrosCheck.addEventListener('change', () => {
      otrosTexto.style.display = otrosCheck.checked ? 'block' : 'none';
      if (!otrosCheck.checked) {
        document.getElementById('otros_detalle').value = '';
      }
    });

    // Modal t√©rminos y condiciones
    const modal = document.getElementById('modal-terminos');
    const abrirTerminos = document.getElementById('abrir-terminos');

    abrirTerminos.addEventListener('click', (e) => {
      e.preventDefault();
      modal.style.display = 'flex';
    });

    function cerrarModal() {
      modal.style.display = 'none';
    }

    window.cerrarModal = cerrarModal; // Para que funcione onclick en HTML

    // Manejo env√≠o formulario
    document.getElementById('form-ayuda').addEventListener('submit', async (e) => {
      e.preventDefault();

      // Validaciones b√°sicas
      const ubicacion = document.getElementById('ubicacion').value.trim();
      if (!ubicacion) {
        alert('Por favor, indica tu ubicaci√≥n o usa el bot√≥n para detectarla.');
        return;
      }

      const nombre = document.getElementById('nombre').value.trim();
      const correo = document.getElementById('correo').value.trim();
      const tiempo = document.getElementById('tiempo').value.trim();
      const terminos = document.getElementById('terminos').checked;

      if (!nombre || !correo || !tiempo) {
        alert('Por favor, completa los campos obligatorios.');
        return;
      }

      if (!terminos) {
        alert('Debes aceptar los t√©rminos y condiciones para enviar la solicitud.');
        return;
      }

      // Obtener etiquetas seleccionadas
      const tags = [...document.querySelectorAll('input[name="tags[]"]:checked')].map(input => input.value);

      if (tags.length === 0) {
        alert('Por favor, selecciona al menos una etiqueta de emergencia.');
        return;
      }

      // Construir objeto para enviar
      const data = {
        ubicacion,
        desc_ubic: document.getElementById('desc_ubic').value.trim(),
        nombre,
        correo,
        telefono: document.getElementById('telefono').value.trim(),
        personales: document.getElementById('personales').value.trim(),
        tiempo,
        tags,
        otros_detalle: document.getElementById('otros_detalle').value.trim(),
        descripcion: document.getElementById('descripcion').value.trim(),
      };

      try {
        const response = await fetch('http://localhost:3000/api/ayuda', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (!response.ok) {
          const error = await response.text();
          alert('Error al enviar la solicitud: ' + error);
          return;
        }

        alert('Solicitud enviada con √©xito. Gracias por usar SomAqui.cat');
        document.getElementById('form-ayuda').reset();
        document.getElementById('ubicacion-texto').textContent = 'üìç Detectar mi ubicaci√≥n autom√°ticamente';
        otrosTexto.style.display = 'none';
        marker.setLatLng([41.3851, 2.1734]);
        map.setView([41.3851, 2.1734], 13);
        document.getElementById('ubicacion').value = '';
      } catch (err) {
        alert('Error de red: ' + err.message);
      }
    });

    // Inicializa el mapa cuando cargue la p√°gina
    window.onload = initMap;
  </script>
</body>

</html>
