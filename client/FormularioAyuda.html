<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pedir Ayuda ‚Äì SomAqui.cat</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="icon" href="Imagenes/LogoSF.png" type="image/png" />
  <link rel="stylesheet" href="style.css">
 
  <link rel="stylesheet" href="css/Styleglobal.css">
  <link rel="stylesheet" href="css/FormularioAyuda.css">
</head>

<body>
  <header class="site-header">
    <div class="header-top">
      <!-- Bot√≥n login a la derecha -->
      <button id="btn-login" aria-label="Iniciar sesi√≥n">
        <svg xmlns="http://www.w3.org/2000/svg" fill="white" width="28" height="28" viewBox="0 0 24 24">
          <path
            d="M12 2C9.243 2 7 4.243 7 7s2.243 5 5 5 5-2.243 5-5-2.243-5-5-5zm0 14c-4.418 0-8 3.134-8 7h2c0-2.761 2.686-5 6-5s6 2.239 6 5h2c0-3.866-3.582-7-8-7z" />
        </svg>
      </button>
    </div>

    <a href="Home.html" class="logo" aria-label="Ir a la p√°gina principal de SomAqui.cat">
      <img src="Imagenes/LogoSF.png" alt="Logo SomAqui.cat" />
      SomAqui.cat
    </a>

    <button class="menu-toggle" aria-controls="main-menu" aria-expanded="false" aria-label="Abrir men√∫ de navegaci√≥n">
      <i class="fa fa-bars"></i>
    </button>

    <nav class="main-nav" role="navigation" aria-label="Men√∫ principal">
      <ul class="nav-list" id="main-menu">
        <li class="nav-item"><a href="Home.html" class="nav-link" aria-current="page">Home</a></li>
        <li class="nav-item"><a href="FormularioAyuda.html" class="nav-link">Necesito Ayuda</a></li>
        <li class="nav-item"><a href="Ayudar.html" class="nav-link">Quiero ser voluntario</a></li>
        <li class="nav-item dropdown" tabindex="0">
          <a href="QuienesSomos.html" class="nav-link" aria-haspopup="true" aria-expanded="false">
            ¬øQui√©nes Somos? <i class="fa fa-caret-down" aria-hidden="true"></i>
          </a>
          <ul class="dropdown-menu" aria-label="Submen√∫ Quienes Somos">
            <li><a href="Equipo.html" class="dropdown-link">Equipo</a></li>
            <li><a href="MisionVision.html" class="dropdown-link">Misi√≥n y Visi√≥n</a></li>
            <li><a href="PreguntasFrecuentes.html" class="dropdown-link">Preguntas frecuentes</a></li>
            <li><a href="Contacto.html" class="dropdown-link">Contacto</a></li>
          </ul>
        </li>
      </ul>
    </nav>
  </header>

  <main>
    <h2>üö® Solicita ayuda en tu zona</h2>
    <p>Selecciona una o m√°s situaciones que est√°s viviendo. La ubicaci√≥n no se mostrar√° p√∫blicamente.
    </p>

  <form id="form-ayuda" novalidate>
      <div class="ubicacion-mapa">
        <!-- Mapa a la izquierda -->
        <div class="mapa-contenedor">
          <!-- Campo oculto para enviar la ubicaci√≥n -->
          <input type="hidden" id="ubicacion" name="ubicacion" required>
          
          <!-- Texto visible de la ubicaci√≥n como bot√≥n -->
          <button type="button" id="ubicacion-texto" class="ubicacion-display">
            üìç Detectar mi ubicaci√≥n autom√°ticamente
          </button>

          <div class="descripcion-ubicacion">
            Haz clic arriba para detectar autom√°ticamente o selecciona manualmente en el mapa.
            Es necesaria para conectar con servicios cercanos.
          </div>

          <div id="map"></div>

          <label for="desc_ubic">üó∫Ô∏è Detalles de ubicaci√≥n (opcional)</label>
          <input type="text" name="desc_ubic" id="desc_ubic" placeholder="Ej: En la rotonda, cerca del ambulatorio...">
          
        </div>

        <!-- Formulario a la derecha -->
        <div class="form-derecha">
          <div class="form-grid">
            <div class="form-group">
              <label for="nombre">üë§ Nombre o alias *</label>
              <input type="text" name="nombre" id="nombre" required placeholder="Tu nombre o alias">
            </div>
            
            <div class="form-group">
              <label for="telefono">üì± Tel√©fono m√≥vil (opcional)</label>
              <input type="tel" name="telefono" id="telefono" required placeholder="Ej: 612 345 678">
            </div>
            
            <div class="form-group">
              <label for="correo">üìß Correo electr√≥nico *</label>
              <input type="email" name="correo" id="correo" required placeholder="ejemplo@correo.com">
            </div>
            
            <div class="form-group">
              <label for ="tiempo">‚è∞ ¬øDesde cu√°ndo ocurre la situaci√≥n? *</label>
              <input type="text" name="tiempo" id="tiempo" required placeholder="Ej: 30 minutos">
            </div>
            
            <div class="form-group full-width">
              <label for="personales">üë• ¬øEs solo para ti o para otras personas tambi√©n?</label>
              <input type="text" name="personales" id="personales" placeholder="Ej: Solo para m√≠ o para mi familia">
            </div>
          </div>
        </div>
      </div>

      <div class="seccion-emergencia">
        <h2 class="titulo-emergencia">Emergencia</h2>
        <label class="etiquetas-titulo">üÜò Selecciona una o m√°s etiquetas *</label>
      </div>

      <!-- Grid de categor√≠as organizadas en recuadros -->
      <div class="categorias-grid">
        <!-- Emergencias clim√°ticas -->
        <div class="categoria-recuadro">
          <div class="categoria-header">
            <h3>üå™Ô∏è Emergencias clim√°ticas</h3>
          </div>
          <div class="etiquetas">
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Incendios forestales" /><span>Incendios forestales</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Inundaciones" /><span>Lluvias intensas</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Ola de calor" /><span>Ola de calor</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Ola de fr√≠o" /><span>Ola de fr√≠o</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Vientos fuertes" /><span>Vientos fuertes</span></label>
          </div>
        </div>

        <!-- Cortes o fallos -->
        <div class="categoria-recuadro">
          <div class="categoria-header">
            <h3>üõë Cortes o fallos</h3>
          </div>
          <div class="etiquetas">
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Corte de luz" /><span>Corte de luz</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Corte de agua" /><span>Corte de agua</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Corte de gas" /><span>Corte de gas</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Corte de Internet" /><span>Corte de Internet</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Apag√≥n general" /><span>Apag√≥n general</span></label>
          </div>
        </div>

        <!-- Necesidades humanas -->
        <div class="categoria-recuadro">
          <div class="categoria-header">
            <h3>üë• Necesidades humanas</h3>
          </div>
          <div class="etiquetas">
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Mayores solos" /><span>Mayores solos</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Personas sin hogar" /><span>Personas sin hogar</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Movilidad reducida" /><span>Movilidad reducida</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Falta de alimentos" /><span>Falta de alimentos</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Falta de medicamentos" /><span>Falta de medicamentos</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Necesidad de transporte" /><span>Necesidad de transporte</span></label>
          </div>
        </div>

        <!-- Apoyo psicosocial -->
        <div class="categoria-recuadro">
          <div class="categoria-header">
            <h3>üß† Apoyo psicosocial</h3>
          </div>
          <div class="etiquetas">
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Ansiedad o crisis emocional" /><span>Ansiedad o crisis emocional</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Necesito hablar" /><span>Necesito hablar</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Necesito contenci√≥n emocional" /><span>Necesito contenci√≥n emocional</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Acompa√±amiento" /><span>Acompa√±amiento</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Ataques de p√°nico" /><span>Ataques de p√°nico</span></label>
          </div>
        </div>

        <!-- Problemas estructurales -->
        <div class="categoria-recuadro">
          <div class="categoria-header">
            <h3>üèòÔ∏è Problemas estructurales</h3>
          </div>
          <div class="etiquetas">
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Desalojo" /><span>Peligro de desalojo</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Calles bloqueadas" /><span>Calles bloqueadas</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Inundaci√≥n interna en la vivienda" /><span>Inundaci√≥n interna en la vivienda</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Da√±os en la vivienda (techos, paredes, ventanas)" /><span>Da√±os en la vivienda (techos, paredes, ventanas)</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Riesgo de derrumbe por lluvias o sismos" /><span>Riesgo de derrumbe por lluvias o sismos</span></label>
          </div>
        </div>

        <!-- Infraestructura -->
        <div class="categoria-recuadro">
          <div class="categoria-header">
            <h3>üß∞ Infraestructura</h3>
          </div>
          <div class="etiquetas">
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Alcantarillado colapsado o desbordado" /><span>Alcantarillado colapsado o desbordado</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Centro cerrado" /><span>Centro c√≠vico cerrado</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Colapso en centros de salud" /><span>Centro de salud colapsado</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Falta de servicios b√°sicos" /><span>Falta de servicios b√°sicos</span></label>
            <label class="etiqueta"><input type="checkbox" name="tags[]" value="Problemas de infraestructura" /><span>Problemas de infraestructura</span></label>
          </div>
        </div>

        <!-- Otra emergencia -->
        <div class="categoria-recuadro categoria-otros">
          <div class="categoria-header">
            <h3>‚ûï Otra emergencia</h3>
          </div>
          <div class="etiquetas">
            <label class="etiqueta">
              <input type="checkbox" id="otros-check" name="tags[]" value="Otros" onchange="toggleOtrosTexto()" />
              <span>Otros</span>
            </label>
          </div>
          <div id="otros-texto-container" style="display:none; margin-top: 1rem;">
            <label for="otros_detalle">üîç Describe tu emergencia:</label>
            <input type="text" name="otros_detalle" id="otros_detalle" placeholder="Describe brevemente tu situaci√≥n...">
          </div>
        </div>
      </div>

      <div class="descripcion-seccion">
        <label for="descripcion">üìù Describe tu situaci√≥n (opcional)</label>
        <textarea name="descripcion" id="descripcion" placeholder="Ej: Estoy sin electricidad desde hace 3 horas y necesito ayuda urgente..."></textarea>
      </div>

        <div class="checkbox-term">
          <input type="checkbox" id="terminos" required>
          <label for="terminos">Acepto los <a href="#" id="abrir-terminos">t√©rminos y condiciones</a> *</label>
        </div>

        <button type="submit">Enviar solicitud</button>
        <div class="privacidad">Tus datos se usan √∫nicamente para activar ayuda cercana.</div>
        <div class="privacidad">Por favor, usa este formulario de manera seria y responsable.</div>
    </form>
  </main>

  <!-- MODAL de T√©rminos y Condiciones -->
  <div id="modal-terminos"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div
      style="background:white; padding:2rem; border-radius:10px; max-width:700px; width:90%; height:90%; overflow:auto; position:relative;">
      <button onclick="cerrarModal()"
        style="position:absolute; top:10px; right:15px; background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
      <h2>T√©rminos y Condiciones de Uso ‚Äì SomAqui.cat</h2>
      <p><strong>√öltima actualizaci√≥n: julio de 2025</strong></p>
      <p><strong>1. Objeto del servicio</strong><br>SomAqui.cat permite a los usuarios registrarse para compartir su
        ubicaci√≥n aproximada y necesidades espec√≠ficas mediante etiquetas, conectarse con personas u organizaciones
        dispuestas a colaborar y participar en iniciativas comunitarias.</p>
      <p><strong>2. Registro de usuarios</strong><br>Se recopilan datos como nombre/alias, correo electr√≥nico y
        ubicaci√≥n aproximada. El usuario debe proporcionar informaci√≥n veraz.</p>
      <p><strong>3. Protecci√≥n de datos personales</strong><br>Se aplica el RGPD. Los datos se tratan confidencialmente
        y no se comparten sin consentimiento.</p>
      <p><strong>4. Uso adecuado</strong><br>Est√° prohibido el uso con fines fraudulentos, pol√≠ticos, comerciales o
        discriminatorios.</p>
      <p><strong>5. Limitaci√≥n de responsabilidad</strong><br>SomAqui.cat act√∫a como intermediario. No garantiza la
        veracidad ni disponibilidad de ayuda.</p>
      <p><strong>6. Modificaciones</strong><br>Nos reservamos el derecho a modificar los t√©rminos en cualquier momento.
      </p>
      <p><strong>7. Aceptaci√≥n</strong><br>Usar la plataforma implica aceptar estos t√©rminos.</p>
      <hr>
      <h3>Pol√≠tica de Privacidad</h3>
      <p><strong>Responsable:</strong> SomAqui.cat</p>
      <p><strong>Finalidad:</strong> Plataforma de ayuda comunitaria. Datos tratados para conectar necesidades con ayuda
        local.</p>
      <p><strong>Base legal:</strong> Consentimiento del usuario.</p>
      <p><strong>Acceso a datos:</strong> Solo el equipo de SomAqui.cat. No hay cesiones sin consentimiento.</p>
      <p><strong>Conservaci√≥n:</strong> Mientras seas usuario. Puedes solicitar la eliminaci√≥n.</p>
      <p><strong>Seguridad:</strong> Se aplican medidas t√©cnicas y organizativas de protecci√≥n.</p>
      <p><strong>Derechos:</strong> Acceso, rectificaci√≥n, eliminaci√≥n, oposici√≥n. Contacta con nosotros para
        ejercerlos.</p>
    </div>
  </div>

  <footer id="contacto">
    <p>
      <a href="#" onclick="alert('Aqu√≠ ir√° el modal de T√©rminos')">T√©rminos y condiciones</a> |
      <a href="Contacto.html">Contacto</a> |
      <a href="Home.html">Inicio</a>
    </p>
    <small>¬© 2025 SomAqui.cat ‚Äì Todos los derechos reservados.</small>
  </footer>

  <!-- POPUP LOGIN CON IFRAME -->
  <div id="popup-login"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
    <div
      style="background:white; padding:0; border-radius:10px; width:95%; max-width:800px; height:90%; min-height:600px; position:relative; box-shadow: 0 0 20px rgba(0,0,0,0.2);">
      <button id="cerrar-popup"
        style="position:absolute; top:1rem; right:1rem; background:none; border:none; font-size:1.5rem; cursor:pointer; z-index:10;">√ó</button>
      <iframe src="login.html" style="width:100%; height:100%; border:none; border-radius:10px;"></iframe>
    </div>
  </div>
<script>
  let map, marker;

  function initMap() {
    map = L.map('map').setView([41.3851, 2.1734], 13); // coords por defecto

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors',
      maxZoom: 19,
    }).addTo(map);

    marker = L.marker([41.3851, 2.1734], { draggable: true }).addTo(map);

    marker.on('dragend', () => {
      const pos = marker.getLatLng();
      document.getElementById('ubicacion').value = `${pos.lat.toFixed(6)},${pos.lng.toFixed(6)}`;
    });

    map.on('click', e => {
      marker.setLatLng(e.latlng);
      document.getElementById('ubicacion').value = `${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}`;
    });
  }

  document.getElementById('ubicacion-texto').addEventListener('click', () => {
    if (!navigator.geolocation) {
      alert('Geolocalizaci√≥n no soportada');
      return;
    }
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      marker.setLatLng([lat, lng]);
      map.setView([lat, lng], 15);
      document.getElementById('ubicacion').value = `${lat.toFixed(6)},${lng.toFixed(6)}`;
      document.getElementById('ubicacion-texto').textContent = `üìç Ubicaci√≥n detectada: ${lat.toFixed(4)}, ${lng.toFixed(4)}`;
    }, () => {
      alert('No se pudo obtener la ubicaci√≥n');
    }, { enableHighAccuracy: true, timeout: 10000 });
  });

  document.getElementById('form-ayuda').addEventListener('submit', async (e) => {
    e.preventDefault();

    const ubicacion = document.getElementById('ubicacion').value.trim();
    if (!ubicacion) {
      alert('Por favor, indica tu ubicaci√≥n o usa el bot√≥n para detectarla.');
      return;
    }

    // Aqu√≠ puedes validar otros campos obligatorios...

    const tags = [...document.querySelectorAll('input[name="tags[]"]:checked')].map(i => i.value);
    if (tags.length === 0) {
      alert('Selecciona al menos una etiqueta.');
      return;
    }

    const data = {
      ubicacion,
      desc_ubic: document.getElementById('desc_ubic').value.trim(),
      nombre: document.getElementById('nombre').value.trim(),
      correo: document.getElementById('correo').value.trim(),
      telefono: document.getElementById('telefono').value.trim(),
      personales: document.getElementById('personales').value.trim(),
      tiempo: document.getElementById('tiempo').value.trim(),
      tags,
      otros_detalle: document.getElementById('otros_detalle').value.trim(),
      descripcion: document.getElementById('descripcion').value.trim(),
    };

    try {
      const res = await fetch('http://localhost:3000/api/ayuda', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (!res.ok) {
        alert('Error al enviar la solicitud');
        return;
      }

      alert('Solicitud enviada con √©xito');
      e.target.reset();
      document.getElementById('ubicacion-texto').textContent = 'üìç Detectar mi ubicaci√≥n autom√°ticamente';
      marker.setLatLng([41.3851, 2.1734]);
      map.setView([41.3851, 2.1734], 13);
      document.getElementById('ubicacion').value = '';
    } catch (error) {
      alert('Error de red: ' + error.message);
    }
  });

  window.onload = initMap;
</script>

  <script src="js/menu.js"></script>
  <script src="js/formularioAyuda.js?v=20250121"></script>
  <script src="js/login.js"></script>
  
  <script>
    // Funci√≥n global para mostrar popup con tama√±o din√°mico
    function mostrarPopupLoginConTamano(src) {
      if (window.mostrarPopupLogin) {
        window.mostrarPopupLogin(src);
      } else {
        // Fallback
        const popup = document.getElementById("popup-login");
        const iframe = popup.querySelector("iframe");
        iframe.src = src;
        popup.style.display = "flex";
      }
    }
    
    // Hacer la funci√≥n disponible globalmente
    window.mostrarPopupLoginConTamano = mostrarPopupLoginConTamano;
  </script>
</body>

</html>